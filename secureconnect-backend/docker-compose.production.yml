# =============================================================================
# DOCKER SECRETS
# =============================================================================
# Note: For docker compose (non-Swarm mode), we use environment variables
# instead of external secrets. Create a .env.production file with these values.
secrets:
  jwt_secret:
    file: ./secrets/jwt_secret.txt
  db_password:
    file: ./secrets/db_password.txt
  cassandra_user:
    file: ./secrets/cassandra_user.txt
  cassandra_password:
    file: ./secrets/cassandra_password.txt
  redis_password:
    file: ./secrets/redis_password.txt
  minio_access_key:
    file: ./secrets/minio_access_key.txt
  minio_secret_key:
    file: ./secrets/minio_secret_key.txt
  smtp_username:
    file: ./secrets/smtp_username.txt
  smtp_password:
    file: ./secrets/smtp_password.txt
  firebase_project_id:
    file: ./secrets/firebase_project_id.txt
  firebase_credentials:
    file: ./secrets/firebase_credentials.json
  turn_user:
    file: ./secrets/turn_user.txt
  turn_password:
    file: ./secrets/turn_password.txt
  grafana_admin_password:
    file: ./secrets/grafana_admin_password.txt

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  secureconnect-net:
    driver: bridge

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  crdb_data:
  cassandra_data:
  redis_data:
  minio_data:
  app_logs:
  backup_data:
  prometheus_data:
  grafana_data:

    # =============================================================================
    # SERVICES
    # =============================================================================
services:

  # --------------------------------------------------------------------------
  # DATABASE: COCKROACHDB (SQL)
  # --------------------------------------------------------------------------
  cockroachdb:
    image: cockroachdb/cockroach:v23.1.0
    container_name: secureconnect_crdb
    ports:
      - "26257:26257" # SQL Port
      - "8085:8080" # UI Admin (changed from 8081 to avoid conflict with auth-service)
    mem_limit: 2g
    mem_reservation: 1g
    # Security: Using --insecure mode for Docker Desktop (no TLS certificates required)
    # PRODUCTION NOTE: For true production deployment, generate certs with: ./scripts/generate-certs.sh
    # and change command to: start-single-node --certs-dir=/cockroach/certs
    # Docker Desktop limitation: TLS certificate mounting requires complex configuration
    # Safe workaround: Use --insecure with network isolation and firewall rules
    command: start-single-node --insecure --store=/cockroach/cockroach-data
    environment:
      - POSTGRES_USER=root
      - POSTGRES_DB=secureconnect_poc
      - COCKROACH_MAX_OFFSET_MEMORY=2GB
    volumes:
      - crdb_data:/cockroach/cockroach-data
    networks:
      - secureconnect-net
    restart: always
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/health?ready=1" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # --------------------------------------------------------------------------
  # DATABASE: CASSANDRA (NoSQL)
  # --------------------------------------------------------------------------
  cassandra:
    image: cassandra:4.1.4 # Pinned to stable 4.x LTS
    container_name: secureconnect_cassandra
    ports:
      - "9042:9042"
    mem_limit: 2g
    mem_reservation: 1g
    secrets:
      - cassandra_user
      - cassandra_password
    environment:
      - CASSANDRA_CLUSTER_NAME=SecConnectCluster
      - CASSANDRA_DC=datacenter1
      - CASSANDRA_RACK=rack1
      - MAX_HEAP_SIZE=1024M
      - HEAP_NEWSIZE=100M
      # Enable authentication
      - CASSANDRA_AUTHENTICATOR=PasswordAuthenticator
      - CASSANDRA_AUTHORIZER=CassandraAuthorizer
      - CASSANDRA_PASSWORD_FILE=/run/secrets/cassandra_password
      - CASSANDRA_USERNAME_FILE=/run/secrets/cassandra_user
    volumes:
      - cassandra_data:/var/lib/cassandra
      - ./scripts/cassandra-init.cql:/docker-entrypoint-initdb.d/init.cql:ro
      - ./scripts/cassandra-auth-setup.cql:/docker-entrypoint-initdb.d/auth-setup.cql:ro
    command: >
      bash -c '
        if [ -f /run/secrets/cassandra_user ]; then
          export CASSANDRA_USER=$$(cat /run/secrets/cassandra_user);
        fi &&
        if [ -f /run/secrets/cassandra_password ]; then
          export CASSANDRA_PASSWORD=$$(cat /run/secrets/cassandra_password);
        fi &&
        docker-entrypoint.sh cassandra -f
      '
    networks:
      - secureconnect-net
    restart: always
    healthcheck:
      test: [ "CMD-SHELL", "if [ -f /run/secrets/cassandra_password ]; then cqlsh -u $$(cat /run/secrets/cassandra_user) -p $$(cat /run/secrets/cassandra_password) -e \"describe cluster\" 2>&1; else cqlsh -e \"describe cluster\" 2>&1; fi" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

  # --------------------------------------------------------------------------
  # CACHE: REDIS
  # --------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: secureconnect_redis
    ports:
      - "6379:6379"
    secrets:
      - redis_password
    volumes:
      - redis_data:/data
    networks:
      - secureconnect-net
    command: >
      sh -c 'if [ -f /run/secrets/redis_password ]; then
        redis-server --requirepass $$(cat /run/secrets/redis_password) --appendonly yes --save 900 1;
      else
        redis-server --appendonly yes --save 900 1;
      fi'
    restart: always
    healthcheck:
      # Support both authenticated and non-authenticated Redis
      test: [ "CMD", "sh", "-c", "redis-cli -a $$(cat /run/secrets/redis_password 2>/dev/null || echo '') ping || redis-cli ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
  # STORAGE: MINIO (Object Storage)
  # --------------------------------------------------------------------------
  minio:
    image: minio/minio # Using latest for development (data format compatibility)
    # For production, pin to specific version: minio/minio:RELEASE.2024-10-02T17-50-41Z
    container_name: secureconnect_minio
    command: server /data --console-address ":9001"
    secrets:
      - minio_access_key
      - minio_secret_key
    environment:
      MINIO_ROOT_USER_FILE: /run/secrets/minio_access_key
      MINIO_ROOT_PASSWORD_FILE: /run/secrets/minio_secret_key
    ports:
      - "9000:9000" # API
      - "9001:9001" # UI Console
    volumes:
      - minio_data:/data
    networks:
      - secureconnect-net
    restart: always
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
      interval: 20s
      timeout: 5s
      retries: 3
      start_period: 30s

  # --------------------------------------------------------------------------
  # API GATEWAY
  # --------------------------------------------------------------------------
  api-gateway:
    build:
      context: ..
      dockerfile: Dockerfile
      args:
        SERVICE_NAME: api-gateway
        CMD: ./cmd/api-gateway
    container_name: api-gateway
    ports:
      - "8080:8080"
    secrets:
      - jwt_secret
      - cassandra_user
      - cassandra_password
      - minio_access_key
      - minio_secret_key
      - smtp_username
      - smtp_password
      - redis_password
    environment:
      - ENV=production
      - PORT=8080
      - DB_HOST=cockroachdb
      - DB_NAME=secureconnect_poc
      - REDIS_HOST=redis
      - REDIS_PASSWORD_FILE=/run/secrets/redis_password
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY_FILE=/run/secrets/minio_access_key
      - MINIO_SECRET_KEY_FILE=/run/secrets/minio_secret_key
      - CASSANDRA_HOST=cassandra
      - CASSANDRA_USER_FILE=/run/secrets/cassandra_user
      - CASSANDRA_PASSWORD_FILE=/run/secrets/cassandra_password
      - JWT_SECRET_FILE=/run/secrets/jwt_secret
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-https://secureconnect.com,https://api.secureconnect.com}
      - SMTP_HOST=${SMTP_HOST:-smtp.gmail.com}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USERNAME_FILE=/run/secrets/smtp_username
      - SMTP_PASSWORD_FILE=/run/secrets/smtp_password
      - SMTP_FROM=${SMTP_FROM:-noreply@secureconnect.com}
      - APP_URL=${APP_URL:-https://secureconnect.com}
      - LOG_OUTPUT=file
      - LOG_FILE_PATH=/logs/api-gateway.log
    volumes:
      - ./configs:/app/configs
      - app_logs:/logs
    depends_on:
      cockroachdb:
        condition: service_healthy
      cassandra:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    networks:
      - secureconnect-net
    mem_limit: 256m
    cpus: '0.5'
    restart: always
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # --------------------------------------------------------------------------
  # AUTH SERVICE
  # --------------------------------------------------------------------------
  auth-service:
    build:
      context: ..
      dockerfile: Dockerfile
      args:
        SERVICE_NAME: auth-service
        CMD: ./cmd/auth-service
    container_name: auth-service
    ports:
      - "8081:8080"
    secrets:
      - jwt_secret
      - db_password
      - smtp_username
      - smtp_password
      - redis_password
    environment:
      - ENV=production
      - PORT=8080
      - DB_HOST=cockroachdb
      - DB_NAME=secureconnect_poc
      - REDIS_HOST=redis
      - REDIS_PASSWORD_FILE=/run/secrets/redis_password
      - JWT_SECRET_FILE=/run/secrets/jwt_secret
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-https://secureconnect.com,https://api.secureconnect.com}
      - SMTP_HOST=${SMTP_HOST:-smtp.gmail.com}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USERNAME_FILE=/run/secrets/smtp_username
      - SMTP_PASSWORD_FILE=/run/secrets/smtp_password
      - SMTP_FROM=${SMTP_FROM:-noreply@secureconnect.com}
      - APP_URL=${APP_URL:-https://secureconnect.com}
      - LOG_OUTPUT=file
      - LOG_FILE_PATH=/logs/auth-service.log
    volumes:
      - app_logs:/logs
    depends_on:
      cockroachdb:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - secureconnect-net
    mem_limit: 256m
    cpus: '0.5'
    restart: always
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # --------------------------------------------------------------------------
  # CHAT SERVICE
  # --------------------------------------------------------------------------
  chat-service:
    build:
      context: ..
      dockerfile: Dockerfile
      args:
        SERVICE_NAME: chat-service
        CMD: ./cmd/chat-service
    container_name: chat-service
    ports:
      - "8082:8082"
    secrets:
      - jwt_secret
      - cassandra_user
      - cassandra_password
      - minio_access_key
      - minio_access_key
      - minio_secret_key
      - db_password
      - redis_password
    environment:
      - ENV=production
      - PORT=8082
      - CASSANDRA_HOST=cassandra
      - CASSANDRA_USER_FILE=/run/secrets/cassandra_user
      - CASSANDRA_PASSWORD_FILE=/run/secrets/cassandra_password
      - REDIS_HOST=redis
      - REDIS_PASSWORD_FILE=/run/secrets/redis_password
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY_FILE=/run/secrets/minio_access_key
      - MINIO_SECRET_KEY_FILE=/run/secrets/minio_secret_key
      - COCKROACH_HOST=cockroachdb
      - DB_NAME=secureconnect_poc
      - JWT_SECRET_FILE=/run/secrets/jwt_secret
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-https://secureconnect.com,https://api.secureconnect.com}
      - LOG_OUTPUT=file
      - LOG_FILE_PATH=/logs/chat-service.log
    volumes:
      - app_logs:/logs
    depends_on:
      cassandra:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    networks:
      - secureconnect-net
    mem_limit: 512m
    cpus: '0.5'
    restart: always
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8082/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # --------------------------------------------------------------------------
  # VIDEO SERVICE (SFU/Pion)
  # --------------------------------------------------------------------------
  video-service:
    build:
      context: ..
      dockerfile: Dockerfile
      args:
        SERVICE_NAME: video-service
        CMD: ./cmd/video-service
    container_name: video-service
    ports:
      - "8083:8083"
    secrets:
      - jwt_secret
      - firebase_project_id
      - firebase_credentials
      - redis_password
    environment:
      - ENV=production
      - PORT=8083
      - REDIS_HOST=redis
      - REDIS_PASSWORD_FILE=/run/secrets/redis_password
      - JWT_SECRET_FILE=/run/secrets/jwt_secret
      - FIREBASE_PROJECT_ID_FILE=/run/secrets/firebase_project_id
      - FIREBASE_CREDENTIALS_PATH=/run/secrets/firebase_credentials
      - PUSH_PROVIDER=firebase
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-https://secureconnect.com,https://api.secureconnect.com}
      - LOG_OUTPUT=file
      - LOG_FILE_PATH=/logs/video-service.log
    volumes:
      - app_logs:/logs
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - secureconnect-net
    mem_limit: 512m
    cpus: '1.0'
    restart: always
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8083/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # --------------------------------------------------------------------------
  # STORAGE SERVICE
  # --------------------------------------------------------------------------
  storage-service:
    build:
      context: ..
      dockerfile: Dockerfile
      args:
        SERVICE_NAME: storage-service
        CMD: ./cmd/storage-service
    container_name: storage-service
    ports:
      - "8084:8084"
    secrets:
      - jwt_secret
      - cassandra_user
      - cassandra_password
      - minio_access_key
      - minio_secret_key
      - db_password
      - redis_password
    environment:
      - ENV=production
      - PORT=8084
      - DB_HOST=cockroachdb
      - DB_NAME=secureconnect_poc
      - REDIS_HOST=redis
      - REDIS_PASSWORD_FILE=/run/secrets/redis_password
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY_FILE=/run/secrets/minio_access_key
      - MINIO_SECRET_KEY_FILE=/run/secrets/minio_secret_key
      - CASSANDRA_HOST=cassandra
      - CASSANDRA_USER_FILE=/run/secrets/cassandra_user
      - CASSANDRA_PASSWORD_FILE=/run/secrets/cassandra_password
      - JWT_SECRET_FILE=/run/secrets/jwt_secret
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-https://secureconnect.com,https://api.secureconnect.com}
      - LOG_OUTPUT=file
      - LOG_FILE_PATH=/logs/storage-service.log
    volumes:
      - app_logs:/logs
    depends_on:
      cockroachdb:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    networks:
      - secureconnect-net
    mem_limit: 256m
    cpus: '0.5'
    restart: always
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8084/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # --------------------------------------------------------------------------
  # TURN SERVER (WebRTC NAT Traversal)
  # --------------------------------------------------------------------------
  turn-server:
    image: coturn/coturn:4.6.2-alpine # Pinned to stable release
    container_name: secureconnect_turn
    ports:
      - "3478:3478/udp" # STUN/TURN UDP
      - "3478:3478/tcp" # STUN/TURN TCP
      - "5349:5349/tcp" # TURN TLS
      - "50100-50150:50100-50150/udp" # Relay ports (changed to avoid port 50071 conflict)
    secrets:
      - turn_user
      - turn_password
    volumes:
      - ./configs/turnserver.conf:/etc/coturn/turnserver.conf:ro
    command: >
      sh -c 'turnserver -c /etc/coturn/turnserver.conf
        --user=$$(cat /run/secrets/turn_user):$$(cat /run/secrets/turn_password)
        --realm=secureconnect
        --verbose'
    networks:
      - secureconnect-net
    restart: always
    healthcheck:
      test: [ "CMD", "sh", "-c", "turnutils_uclient -u $$(cat /run/secrets/turn_user) -w $$(cat /run/secrets/turn_password) 127.0.0.1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # --------------------------------------------------------------------------
  # PROMETHEUS (Metrics Collection)
  # --------------------------------------------------------------------------
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: secureconnect_prometheus
    ports:
      - "9091:9090"
    volumes:
      - prometheus_data:/prometheus
      - ./configs/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./configs/alerts.yml:/etc/prometheus/alerts.yml:ro
    networks:
      - secureconnect-net
    restart: always
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # --------------------------------------------------------------------------
  # ALERTMANAGER (Prometheus Alerting)
  # --------------------------------------------------------------------------
  alertmanager:
    image: prom/alertmanager:v0.26.0
    container_name: secureconnect_alertmanager
    ports:
      - "9093:9093"
    volumes:
      - ./configs/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
    networks:
      - secureconnect-net
    restart: always
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:9093/-/healthy" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # --------------------------------------------------------------------------
  # BACKUP SCHEDULER (Automated Backups)
  # --------------------------------------------------------------------------
  backup-scheduler:
    image: alpine:3.19 # Pinned to stable release
    container_name: secureconnect_backup
    volumes:
      - ./scripts:/app/scripts:ro
      - backup_data:/backups
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - BACKUP_RETENTION_DAYS=7
      - BACKUP_SCHEDULE=0 2 * * *
    command: >
      sh -c 'apk add --no-cache docker-cli bash &&
             echo "$$BACKUP_SCHEDULE /app/scripts/backup-databases.sh /backups >> /var/log/backup.log 2>&1" | crontab - &&
             crond -f -l 2'
    networks:
      - secureconnect-net
    restart: always
    healthcheck:
      test: [ "CMD", "pgrep", "-f", "crond" ]
      interval: 60s
      timeout: 10s
      retries: 3

  # --------------------------------------------------------------------------
  # LOAD BALANCER (NGINX)
  # --------------------------------------------------------------------------
  gateway:
    image: nginx:alpine
    container_name: secureconnect_nginx
    ports:
      - "80:80" # HTTP Public
      - "443:443" # HTTPS Public
    volumes:
      - ./configs/nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      api-gateway:
        condition: service_healthy
      chat-service:
        condition: service_healthy
      auth-service:
        condition: service_healthy
      video-service:
        condition: service_healthy
      storage-service:
        condition: service_healthy
    networks:
      - secureconnect-net
    restart: always
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
